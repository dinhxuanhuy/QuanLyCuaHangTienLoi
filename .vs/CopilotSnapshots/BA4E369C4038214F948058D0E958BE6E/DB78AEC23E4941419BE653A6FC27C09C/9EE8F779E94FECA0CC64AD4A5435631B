using BusinessAccessLayer;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace QuanLyCuaHangTienLoi
{
    public partial class UCQuanLyTaiKhoan : UserControl
    {
        // Định nghĩa sự kiện để chuyển trang
        public delegate void NavigateRequestEventHandler(UserControl uc);
        public event NavigateRequestEventHandler NavigateRequest;

        BALTaiKhoan dbtk = null;

        public UCQuanLyTaiKhoan()
        {
            InitializeComponent();
            dbtk = new BALTaiKhoan();
            
            // Chỉ hiển thị panel đăng xuất
            pan_dangXuat.Show();
            pan_dangXuat.BringToFront();
        }

        // Phương thức public để cập nhật thông tin người dùng đã đăng nhập
        public void CapNhatThongTinNguoiDung(string tenDangNhap)
        {
            if (txt_tenDangXuat != null)
            {
                txt_tenDangXuat.Text = tenDangNhap;
            }
        }

        // Xử lý đăng xuất
        private void btn_dangXuat_Click(object sender, EventArgs e)
        {
            DialogResult result = MessageBox.Show(
                "Bạn có chắc chắn muốn đăng xuất?", 
                "Xác nhận đăng xuất", 
                MessageBoxButtons.YesNo, 
                MessageBoxIcon.Question);

            if (result == DialogResult.Yes)
            {
                frmTrangChu formCha = this.ParentForm as frmTrangChu;
                if (formCha != null)
                {
                    // Vô hiệu hóa tất cả các nút menu
                    formCha.btn_quanLyCa.Enabled = false;
                    formCha.btn_quanLyDuLieu.Enabled = false;
                    formCha.btn_quanLyHoaDon.Enabled = false;
                    formCha.btn_quanLyTaiKhoan.Enabled = false;
                    formCha.btn_thongKe.Enabled = false;
                    formCha.btn_chatBox.Enabled = false;
                }

                // Xóa thông tin đăng nhập
                txt_tenDangXuat.Text = "";
                frmTrangChu.MaNV = "";

                MessageBox.Show("Đã đăng xuất thành công!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);

                // Đóng form trang chủ và mở lại form đăng nhập
                Form parentForm = this.FindForm();
                if (parentForm != null)
                {
                    parentForm.Hide();
                    frmDangNhap frmLogin = new frmDangNhap();
                    frmLogin.ShowDialog();
                    parentForm.Close();
                }
            }
        }

        // Nút đăng ký - Chỉ dành cho admin, hiển thị form đăng ký riêng
        private void btn_dangKy_Click(object sender, EventArgs e)
        {
            // Kiểm tra quyền admin (dựa vào vai trò được lưu trong session hoặc static variable)
            frmTrangChu formCha = this.ParentForm as frmTrangChu;
            if (formCha != null)
            {
                // Lấy thông tin vai trò từ database
                string err = "";
                string maVaiTro = "";
                
                // Lấy username hiện tại
                string currentUser = txt_tenDangXuat.Text;
                
                if (!string.IsNullOrEmpty(currentUser))
                {
                    // Kiểm tra vai trò
                    DataTable dt = dbtk.LayThongTinTaiKhoan(currentUser, ref err);
                    if (dt != null && dt.Rows.Count > 0)
                    {
                        maVaiTro = dt.Rows[0]["MaVaiTro"].ToString();
                        
                        if (maVaiTro == "Quản lý" || maVaiTro == "QL")
                        {
                            // Mở form đăng ký mới (có thể tạo một form riêng cho chức năng này)
                            MessageBox.Show("Chức năng đăng ký tài khoản mới sẽ được triển khai trong phiên bản sau.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        }
                        else
                        {
                            MessageBox.Show("Chỉ có người quản trị mới có quyền đăng ký tài khoản mới!", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                        }
                    }
                }
            }
        }
    }
}
