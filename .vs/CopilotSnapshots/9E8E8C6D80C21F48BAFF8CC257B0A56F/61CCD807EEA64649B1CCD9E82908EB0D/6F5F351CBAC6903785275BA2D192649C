using DataAccessLayer;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.ChatCompletion;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using System;
using System.Text;
using System.Threading.Tasks;

namespace DataAccessLayer
{
    internal class SqlAgent
    {
        string apiKey;
        string modelId;
        private static SqlAgent instance = null;
        Kernel kernel;
        IChatCompletionService chatService;
        public SqlAgent() {
            apiKey = "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";
            modelId = "gpt-4o-mini";
            var kernel = Kernel.CreateBuilder().AddOpenAIChatCompletion(modelId, apiKey).Build();
            kernel.Plugins.AddFromObject(DAL.Instance);
            chatService = kernel.GetRequiredService<IChatCompletionService>();
        }
        public static SqlAgent Instance
        {
            get
            {
                if (instance == null)
                {
                    instance = new SqlAgent();
                }
                
                return instance;
            }
        }
        public static async Task<String> GetAnswer(IChatCompletionService chatservice, Kernel kernel, String question)
        {
            var chat = new ChatHistory();
            chat.AddSystemMessage(@"You are a helpful AI assistant for a store management application.
When user ask questions , generate appropriate SQL queries to retrieve the necessary data.
Always be friendly and explain your clearly.");
            chat.AddUserMessage(question);
            var settings = new OpenAIPromptExecutionSettings()
            {
                ToolCallBehavior = ToolCallBehavior.AutoInvokeKernelFunctions,
                Temperature = 0.1,
            };
            var response = await chatservice.GetChatMessageContentAsync(chat, settings, kernel);
            return response.Content ?? "I'm sorry, I don't have an answer for that.";
        }

    }
}
