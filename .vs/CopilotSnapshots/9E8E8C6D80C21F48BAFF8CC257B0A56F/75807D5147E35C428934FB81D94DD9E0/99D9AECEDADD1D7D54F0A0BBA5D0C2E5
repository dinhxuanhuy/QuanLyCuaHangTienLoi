using System;
using System.Drawing;
using System.Drawing.Drawing2D;
using System.Drawing.Text;
using System.Text;
using System.Windows.Forms;
using DataAccessLayer;

namespace QuanLyCuaHangTienLoi
{
    public partial class UCChatbox : UserControl
    {
        private SqlAgent sqlAgent;

        public UCChatbox()
        {
            InitializeComponent();
            SetupChatContainer();
        }

        private void SetupChatContainer()
        {
            // Enable double buffering for smooth scrolling
            typeof(Panel).InvokeMember("DoubleBuffered",
                System.Reflection.BindingFlags.SetProperty | System.Reflection.BindingFlags.Instance | System.Reflection.BindingFlags.NonPublic,
                null, chatContainer, new object[] { true });
        }

        private void UCChatbox_Load(object sender, EventArgs e)
        {
            // Set encoding
            Encoding.RegisterProvider(CodePagesEncodingProvider.Instance);

            // Initialize SQL Agent
            try
            {
                sqlAgent = SqlAgent.Instance;
                AddBotMessage("Xin chào! 👋\n\nTôi là **trợ lý AI** của cửa hàng. Tôi có thể giúp bạn:\n\n• Tìm kiếm thông tin sản phẩm\n• Tra cứu đơn hàng\n• Thống kê doanh thu\n• Quản lý nhân viên\n\nHãy hỏi tôi bất cứ điều gì! 💬");
            }
            catch (Exception ex)
            {
                AddBotMessage($"❌ **Lỗi khởi tạo AI:**\n```\n{ex.Message}\n```");
            }
        }

        private void btnSend_Click(object sender, EventArgs e)
        {
            SendMessage();
        }

        private void txtMessage_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter && !e.Shift)
            {
                e.SuppressKeyPress = true;
                SendMessage();
            }
        }

        private async void SendMessage()
        {
            string message = txtMessage.Text.Trim();
            if (string.IsNullOrEmpty(message))
                return;

            // Add user message to chat
            AddUserMessage(message);

            // Clear input
            txtMessage.Clear();

            // Disable input while processing
            txtMessage.Enabled = false;
            btnSend.Enabled = false;

            // Show processing message with animation
            var processingPanel = AddBotMessage("🤔 Đang phân tích câu hỏi của bạn...");

            try
            {
                // Get AI response
                string response = await sqlAgent.GetAnswer(message);

                // Remove processing message
                if (chatContainer.Controls.Contains(processingPanel))
                {
                    chatContainer.Controls.Remove(processingPanel);
                }

                // Add AI response
                AddBotMessage(response);
            }
            catch (Exception ex)
            {
                // Remove processing message
                if (chatContainer.Controls.Contains(processingPanel))
                {
                    chatContainer.Controls.Remove(processingPanel);
                }

                AddBotMessage($"❌ **Đã xảy ra lỗi:**\n\n```\n{ex.Message}\n```\n\nVui lòng thử lại sau.");
            }
            finally
            {
                // Re-enable input
                txtMessage.Enabled = true;
                btnSend.Enabled = true;
                txtMessage.Focus();
            }
        }

        private void AddUserMessage(string message)
        {
            var messagePanel = CreateMessagePanel(message, true);
            chatContainer.Controls.Add(messagePanel);
            
            // Smooth scroll to bottom
            chatContainer.ScrollControlIntoView(messagePanel);
            Application.DoEvents();
        }

        private Panel AddBotMessage(string message)
        {
            var messagePanel = CreateMessagePanel(message, false);
            chatContainer.Controls.Add(messagePanel);
            
            // Smooth scroll to bottom
            chatContainer.ScrollControlIntoView(messagePanel);
            Application.DoEvents();
            
            return messagePanel;
        }

        private Panel CreateMessagePanel(string message, bool isUser)
        {
            var mainPanel = new Panel
            {
                Width = chatContainer.Width - 30,
                AutoSize = true,
                Padding = new Padding(10, 8, 10, 8),
                Margin = new Padding(0, 6, 0, 6)
            };

            // Create avatar
            var avatar = CreateAvatar(isUser);
            
            // Create message bubble
            var messageBox = CreateMessageBubble(message, isUser);

            // Add controls based on user/bot
            if (isUser)
            {
                messageBox.Location = new Point(mainPanel.Width - messageBox.Width - avatar.Width - 20, 0);
                avatar.Location = new Point(mainPanel.Width - avatar.Width - 10, 0);
            }
            else
            {
                avatar.Location = new Point(10, 0);
                messageBox.Location = new Point(avatar.Width + 20, 0);
            }

            mainPanel.Controls.Add(avatar);
            mainPanel.Controls.Add(messageBox);
            mainPanel.Height = Math.Max(messageBox.Height, avatar.Height) + 16;

            return mainPanel;
        }

        private Panel CreateAvatar(bool isUser)
        {
            var avatar = new Panel
            {
                Size = new Size(40, 40),
                BackColor = isUser ? Color.FromArgb(59, 130, 246) : Color.FromArgb(16, 185, 129)
            };

            // Paint rounded avatar
            avatar.Paint += (s, e) =>
            {
                e.Graphics.SmoothingMode = SmoothingMode.AntiAlias;
                using (var path = GetRoundedRectPath(avatar.ClientRectangle, 20))
                {
                    using (var brush = new SolidBrush(avatar.BackColor))
                    {
                        e.Graphics.FillPath(brush, path);
                    }
                }

                // Draw icon
                string icon = isUser ? "👤" : "🤖";
                using (var font = new Font("Segoe UI Emoji", 16F))
                using (var brush = new SolidBrush(Color.White))
                {
                    var size = e.Graphics.MeasureString(icon, font);
                    var x = (avatar.Width - size.Width) / 2;
                    var y = (avatar.Height - size.Height) / 2;
                    e.Graphics.DrawString(icon, font, brush, x, y);
                }
            };

            return avatar;
        }

        private Panel CreateMessageBubble(string message, bool isUser)
        {
            var messageBox = new Panel
            {
                AutoSize = true,
                MaximumSize = new Size(chatContainer.Width - 180, 0),
                Padding = new Padding(16, 12, 16, 12),
                BackColor = isUser ? Color.FromArgb(59, 130, 246) : Color.White
            };

            // Add shadow effect for bot messages
            if (!isUser)
            {
                messageBox.Paint += (s, e) =>
                {
                    // Draw shadow
                    using (var shadowPath = GetRoundedRectPath(
                        new Rectangle(2, 2, messageBox.Width - 2, messageBox.Height - 2), 12))
                    {
                        using (var shadowBrush = new SolidBrush(Color.FromArgb(30, 0, 0, 0)))
                        {
                            e.Graphics.FillPath(shadowBrush, shadowPath);
                        }
                    }
                    
                    // Draw rounded background
                    using (var path = GetRoundedRectPath(
                        new Rectangle(0, 0, messageBox.Width - 2, messageBox.Height - 2), 12))
                    {
                        using (var brush = new SolidBrush(messageBox.BackColor))
                        {
                            e.Graphics.SmoothingMode = SmoothingMode.AntiAlias;
                            e.Graphics.FillPath(brush, path);
                        }
                    }
                };
            }
            else
            {
                messageBox.Paint += (s, e) =>
                {
                    using (var path = GetRoundedRectPath(
                        new Rectangle(0, 0, messageBox.Width, messageBox.Height), 12))
                    {
                        using (var brush = new SolidBrush(messageBox.BackColor))
                        {
                            e.Graphics.SmoothingMode = SmoothingMode.AntiAlias;
                            e.Graphics.FillPath(brush, path);
                        }
                    }
                };
            }

            // Create RichTextBox with Markdown rendering
            var rtbMessage = MarkdownRenderer.CreateFormattedTextBox(
                message,
                chatContainer.Width - 200,
                isUser
            );

            messageBox.Controls.Add(rtbMessage);

            return messageBox;
        }

        private GraphicsPath GetRoundedRectPath(Rectangle rect, int radius)
        {
            var path = new GraphicsPath();
            int diameter = radius * 2;

            path.AddArc(rect.X, rect.Y, diameter, diameter, 180, 90);
            path.AddArc(rect.Right - diameter, rect.Y, diameter, diameter, 270, 90);
            path.AddArc(rect.Right - diameter, rect.Bottom - diameter, diameter, diameter, 0, 90);
            path.AddArc(rect.X, rect.Bottom - diameter, diameter, diameter, 90, 90);
            path.CloseFigure();

            return path;
        }

        private void btnClear_Click(object sender, EventArgs e)
        {
            chatContainer.Controls.Clear();
            AddBotMessage("✨ **Cuộc trò chuyện đã được xóa.**\n\nTôi có thể giúp gì cho bạn?");
        }

        private void txtMessage_TextChanged(object sender, EventArgs e)
        {
            // Enable/disable send button based on text
            btnSend.Enabled = !string.IsNullOrWhiteSpace(txtMessage.Text);
        }
    }
}
