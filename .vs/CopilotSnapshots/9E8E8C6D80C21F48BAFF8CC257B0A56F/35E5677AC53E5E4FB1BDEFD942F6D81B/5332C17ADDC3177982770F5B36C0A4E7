using System;
using System.Drawing;
using System.Windows.Forms;
using DataAccessLayer;

namespace QuanLyCuaHangTienLoi
{
    public partial class UCChatbox : UserControl
    {
        private SqlAgent sqlAgent;
        
        public UCChatbox()
        {
            InitializeComponent();
        }

        private void UCChatbox_Load(object sender, EventArgs e)
        {
            // Initialize SQL Agent
            try
            {
                sqlAgent = SqlAgent.Instance;
                AddBotMessage("Xin chào! Tôi là tr? lý AI c?a c?a hàng. Tôi có th? giúp b?n tìm ki?m thông tin v? s?n ph?m, ??n hàng, nhân viên và nhi?u h?n n?a. Hãy h?i tôi b?t c? ?i?u gì!");
            }
            catch (Exception ex)
            {
                AddBotMessage($"L?i kh?i t?o AI: {ex.Message}");
            }
        }

        private void btnSend_Click(object sender, EventArgs e)
        {
            SendMessage();
        }

        private void txtMessage_KeyDown(object sender, KeyEventArgs e)
        {
            if (e.KeyCode == Keys.Enter && !e.Shift)
            {
                e.SuppressKeyPress = true;
                SendMessage();
            }
        }

        private async void SendMessage()
        {
            string message = txtMessage.Text.Trim();
            if (string.IsNullOrEmpty(message))
                return;

            // Add user message to chat
            AddUserMessage(message);

            // Clear input
            txtMessage.Clear();
            
            // Disable input while processing
            txtMessage.Enabled = false;
            btnSend.Enabled = false;

            // Show processing message
            AddBotMessage("?? ?ang suy ngh?...");

            try
            {
                // Get AI response
                string response = await sqlAgent.GetAnswer(message);
                
                // Remove processing message
                if (chatContainer.Controls.Count > 0)
                {
                    chatContainer.Controls.RemoveAt(chatContainer.Controls.Count - 1);
                }
                
                // Add AI response
                AddBotMessage(response);
            }
            catch (Exception ex)
            {
                // Remove processing message
                if (chatContainer.Controls.Count > 0)
                {
                    chatContainer.Controls.RemoveAt(chatContainer.Controls.Count - 1);
                }
                
                AddBotMessage($"? L?i: {ex.Message}");
            }
            finally
            {
                // Re-enable input
                txtMessage.Enabled = true;
                btnSend.Enabled = true;
                txtMessage.Focus();
            }
        }

        private void AddUserMessage(string message)
        {
            var messagePanel = CreateMessagePanel(message, true);
            chatContainer.Controls.Add(messagePanel);
            chatContainer.ScrollControlIntoView(messagePanel);
        }

        private void AddBotMessage(string message)
        {
            var messagePanel = CreateMessagePanel(message, false);
            chatContainer.Controls.Add(messagePanel);
            chatContainer.ScrollControlIntoView(messagePanel);
        }

        private Panel CreateMessagePanel(string message, bool isUser)
        {
            var mainPanel = new Panel
            {
                Width = chatContainer.Width - 30,
                AutoSize = true,
                Padding = new Padding(10, 5, 10, 5),
                Margin = new Padding(0, 5, 0, 5)
            };

            var messageBox = new Panel
            {
                AutoSize = true,
                MaximumSize = new Size(chatContainer.Width - 150, 0),
                Padding = new Padding(15, 10, 15, 10),
                BackColor = isUser ? Color.FromArgb(59, 130, 246) : Color.FromArgb(243, 244, 246)
            };

            var lblMessage = new Label
            {
                Text = message,
                AutoSize = true,
                MaximumSize = new Size(chatContainer.Width - 180, 0),
                Font = new Font("Segoe UI", 10F),
                ForeColor = isUser ? Color.White : Color.FromArgb(31, 41, 55)
            };

            messageBox.Controls.Add(lblMessage);

            if (isUser)
            {
                messageBox.Location = new Point(mainPanel.Width - messageBox.Width - 10, 0);
            }
            else
            {
                messageBox.Location = new Point(10, 0);
            }

            mainPanel.Controls.Add(messageBox);
            mainPanel.Height = messageBox.Height + 10;

            return mainPanel;
        }

        private void btnClear_Click(object sender, EventArgs e)
        {
            chatContainer.Controls.Clear();
            AddBotMessage("Cu?c trò chuy?n ?ã ???c xóa. Tôi có th? giúp gì cho b?n?");
        }
    }
}
