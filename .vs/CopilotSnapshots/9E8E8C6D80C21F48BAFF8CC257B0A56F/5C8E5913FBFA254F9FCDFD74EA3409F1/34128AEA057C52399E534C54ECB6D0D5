using DataAccessLayer;
using Microsoft.Extensions.DependencyInjection;
using Microsoft.SemanticKernel;
using Microsoft.SemanticKernel.ChatCompletion;
using Microsoft.SemanticKernel.Connectors.OpenAI;
using System;
using System.Text;
using System.Threading.Tasks;

namespace DataAccessLayer
{
    public class SqlAgent
    {
        string apiKey;
        string modelId;
        private static SqlAgent instance = null;
        Kernel kernel;
        IChatCompletionService chatService;
        
        private SqlAgent() {
            apiKey = "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";
            modelId = "gpt-4o-mini";
            kernel = Kernel.CreateBuilder().AddOpenAIChatCompletion(modelId, apiKey).Build();
            
            var dalInstance = DAL.Instance;
            dalInstance.connectionString = "Data Source=HUY-G14;Initial Catalog=QuanLyCuaHangTienLoi;Integrated Security=True;Encrypt=True;TrustServerCertificate=True";
            kernel.Plugins.AddFromObject(dalInstance);
            
            chatService = kernel.GetRequiredService<IChatCompletionService>();
        }
        
        public static SqlAgent Instance
        {
            get
            {
                if (instance == null)
                {
                    instance = new SqlAgent();
                }
                
                return instance;
            }
        }
        
        public async Task<string> GetAnswer(string question)
        {
            var chat = new ChatHistory();
            chat.AddSystemMessage(@"You are a helpful AI assistant for a store management application.
When user ask questions, generate appropriate SQL queries to retrieve the necessary data.
Always be friendly and explain your answers clearly.
IMPORTANT: Always respond in Vietnamese language.");
            chat.AddUserMessage(question);
            
            var settings = new OpenAIPromptExecutionSettings()
            {
                ToolCallBehavior = ToolCallBehavior.AutoInvokeKernelFunctions,
                Temperature = 0.1,
            };
            
            var response = await chatService.GetChatMessageContentAsync(chat, settings, kernel);
            return response.Content ?? "Xin lỗi, tôi không có câu trả lời cho câu hỏi đó.";
        }
    }
}
